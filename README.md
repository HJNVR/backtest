## Overview

This project aims to build machine learning model for prediction of future stock performance. The model will use features generated from 11 academic papers to predict future stock prices and select best-performing stocks from the S&P500 index. The selected stocks will form a potfolio whose performance will then be compared against the performance of the S&P500 index.

The methodology used in this project include:

 - Highly robust feature selection and leak detection
 - Accurate and various hyper-parameter optimization in high-dimensional space
 - State-of-the-art predictive models for regression task about rate of return
 - Automatic results evaluation with metrics reports and plots
 - Predictions with interpretations

## Structure of Repository folders/files

 - **`config`**: All configuration json files are stored here
 - **`data`**: This is the warehouse to store all required or automatically generated datasets for the experiments and the whole project
 - **`high-priority-papers`**: Feature generation from reference papers shoudlb be done in this folder for future usage and referring
 - **`result`**: An automatically generated folder used to keep all results that generated by the code
 - **`src`**: This is the source folder where main functions are
    - **`tools`**: It contains all codes with well-wrapped functions and methods that will be frequently used in the future

## AWS setting 
 - Register AWS account and genreate new access secret key
 - Install AWS CLI 
    - command: `pip install awscli`
      - for windows : `https://awscli.amazonaws.com/AWSCLIV2.msi`
    - command: `aws configure`
    - AWS Access Key ID: AKIAVNMK4EB****
    - AWS Secret Access Key: KZXHnAhU5Sd0sR5F****
    - Default region name: ap-southeast-1
    - Default output format: json
 - Go to aws folder
    - command: `cd .aws`
    - command: `cat credentials`
- Install boto3
    - command: `pip install boto3`
- check `status.csv`
    - search `S3` in AWS website and find `backtest` bucket

## Dependencies

The basic requirements are listed below:

```
boruta==0.3
yahoo_fin==0.8.9.1
lightgbm==3.3.1
python-dateutil==2.8.1
pandas==1.1.3
numpy==1.19.2
scikit-learn
tensorflow==2.7.0
keras==2.7.0
tqdm==4.50.2
optuna==2.10.0
```

More Details about all the packages dependencies for my Mac laptop are recorded in `requirements.txt`. Check it if you have any unexpected version issue.

## Configuration Settings

Take the configuration of back test as an example:

```
{   "ml_config": "Below are config settings for ML model",
    "ml_parameters" : {
                "kfold": 5,
                "train_period": [10, 15],
                "test_period": [1], 
                "topk": [10],
                "money": 100000, 
                "comment": "first_train_end_ym should be at least 2000 + the max of train_valid_period",
                "first_train_end_ym": "201701",
                "comment" : "end_date cannot beyond the last date of dataframe", 
                "end_date": "202203",
                "tune_sampler": "tpe",
                "train_valid_period": [16, 17],
                "tune_trials": 1,
                "method_comment" : "logisitc regression, xgboost",
                "md": "lr",
                "fs_commnent" : "available feature selection methods: lgb, boruta, empty, rfecv, mi",
                "fs": ["mi", ""],
                "y_col_prefix": "fut_ret",
                "primary_key": ["ticker", "permno", "date"]

                },
    "logistic_parameters" : {
                "percentile": 0.2,
                "threshold": 0.1
                },
    "common_settings" :{
                "paper_id_comment" : "choose from ['all', 'paper1', 'paper3', 'paper4', 'paper6', 'paper7', 'paper9', 'paper11']",
                "paper_id" : "paper9",
                "debug_mode_comment" : "T/F",
                "debug_mode" : "F",
                "deubg_model_comment" : "T/F number of virtual machine",
                "parallel_compute" : "F"
                },
    "file_paths": {
                "result_path" : "../result/",
                "spy_daily_prc_path" : "../data/spy_daily_prc.csv",
                "sp500_daily_prc_path" : "../data/sp500_daily_prc.csv",
                "paper1_features_path" : "../data/paper1_features.csv",
                "paper3_features_path" : "../data/paper3_features.csv",
                "paper4_features_path" : "../data/paper4_features.csv",
                "paper6_features_path" : "../data/paper6_features.csv",
                "paper7_features_path" : "../data/paper7_features.csv",
                "paper9_features_path" : "../data/paper9_features.csv",
                "paper11_features_path" : "../data/paper11_features.csv",
                "consolidated_features_path" : "../data/consolidated_features.csv",
                "paper1_final_summary_path" : "../result/paper1/final_summary.csv",
                "paper3_final_summary_path" : "../result/paper3/final_summary.csv",
                "paper4_final_summary_path" : "../result/paper4/final_summary.csv",
                "paper6_final_summary_path" : "../result/paper6/final_summary.csv",
                "paper7_final_summary_path" : "../result/paper7/final_summary.csv",
                "paper9_final_summary_path" : "../result/paper9/final_summary.csv",
                "paper11_final_summary_path" : "../result/paper11/final_summary.csv",
                "consolidated_final_summary_path" : "../result/consolidated/final_summary.csv",
                "sample_final_summary_path" : "../result/sample/sample_final_summary.csv",
                "paper1_kpi_result_path" : "../result/paper1/backtest_kpi.png",
                "paper3_kpi_result_path" : "../result/paper3/backtest_kpi.png",
                "paper4_kpi_result_path" : "../result/paper4/backtest_kpi.png",
                "paper6_kpi_result_path" : "../result/paper6/backtest_kpi.png",
                "paper7_kpi_result_path" : "../result/paper7/backtest_kpi.png",
                "paper9_kpi_result_path" : "../result/paper9/backtest_kpi.png",
                "paper11_kpi_result_path" : "../result/paper11/backtest_kpi.png",
                "consolidated_kpi_result_path" : "../result/consolidated/backtest_kpi.png",
                "sample_kpi_result_path" : "../result/sample/backtest_kpi.png"
                }
}

```

## How to Run

- Step 1 : Before running the code, make sure all datasets required in the code are placed in the `data` folder. The required datasets are
    - SPY daily price (auto)
    - SP500 daily price (auto)
    - sp500_list

    The `sp500_list.csv` contains the primary key of the feature data, which shoule be confirmed in the future. Currently, it is just fixed.

    The 2 daily price data file can be generated by running test code in the `tools/yh_data.py`

    ```
    df = download_sp500("1999-12-01", "2022-03-31")
    df.to_csv('./sp500_daily_prc.csv', index=False)
    df = download_spy("1999-12-01", "2022-03-31")
    df.to_csv('./spy_daily_prc.csv', index=False)
    ```

- Step 2 : Feature generations in `high-priorty-papers` folder

- Step 3: The final code will be in the `back_test.py`.
    Set up virtual environment
    - create virtual environment `backtest_env` with all necessary dependencies
        - command: `conda env create -f env.yml`
    - activate 'backtest_env'
        - command: `conda activate backtest_env`
    - check location of 'backtest_env'
        - command: `conda backtest_env list`

    After modifying the information in the correspoding configuration file in `config`, run:

    ```
    python backtest.py
    ```
    After completion, all expected results will wait for you in the `result` folder.


## Outputs
structure(one output for each paper(1-11), all combine totger one output), one output three charts and a summary.csv for each folder  
ex: screenshot (kpi_result_9 for paper9)
- Sample folder: Please copy and paste the following conifg into back_test.json

```
{   "ml_config": "Below are config settings for ML model",
    "ml_parameters" : {
                "kfold": 5,
                "train_period": [10, 15],
                "test_period": [1], 
                "topk": [10],
                "money": 100000, 
                "comment": "first_train_end_ym should be at least 2000 + the max of train_valid_period",
                "first_train_end_ym": "201701",
                "comment" : "end_date cannot beyond the last date of dataframe", 
                "end_date": "201705",
                "tune_sampler": "tpe",
                "train_valid_period": [16, 17],
                "tune_trials": 1,
                "method_comment" : "logisitc regression, xgboost",
                "md": "lr",
                "fs_commnent" : "available feature selection methods: lgb, boruta, empty, rfecv, mi",
                "fs": ["mi", ""],
                "y_col_prefix": "fut_ret",
                "primary_key": ["ticker", "permno", "date"]

                },
    "logistic_parameters" : {
                "percentile": 0.2,
                "threshold": 0.1
                },
    "common_settings" :{
                "paper_id_comment" : "choose from ['all', 'paper1', 'paper3', 'paper4', 'paper6', 'paper7', 'paper9', 'paper11', 'sample']",
                "paper_id" : "sample",
                "debug_mode_comment" : "T/F",
                "debug_mode" : "F",
                "parallel_compute_comment" : "T/F number of virtual machine",
                "parallel_compute" : "F"
                },
    "file_paths": {
                "result_path" : "../result/",
                "spy_daily_prc_path" : "../data/spy_daily_prc.csv",
                "sp500_daily_prc_path" : "../data/sp500_daily_prc.csv",
                "paper1_features_path" : "../data/paper1_features.csv",
                "paper3_features_path" : "../data/paper3_features.csv",
                "paper4_features_path" : "../data/paper4_features.csv",
                "paper6_features_path" : "../data/paper6_features.csv",
                "paper7_features_path" : "../data/paper7_features.csv",
                "paper9_features_path" : "../data/paper9_features.csv",
                "paper11_features_path" : "../data/paper11_features.csv",
                "consolidated_features_path" : "../data/consolidated_features.csv",
                "paper1_final_summary_path" : "../result/paper1/final_summary.csv",
                "paper3_final_summary_path" : "../result/paper3/final_summary.csv",
                "paper4_final_summary_path" : "../result/paper4/final_summary.csv",
                "paper6_final_summary_path" : "../result/paper6/final_summary.csv",
                "paper7_final_summary_path" : "../result/paper7/final_summary.csv",
                "paper9_final_summary_path" : "../result/paper9/final_summary.csv",
                "paper11_final_summary_path" : "../result/paper11/final_summary.csv",
                "consolidated_final_summary_path" : "../result/consolidated/final_summary.csv",
                "sample_final_summary_path" : "../result/sample/sample_final_summary.csv",
                "paper1_kpi_result_path" : "../result/paper1/backtest_kpi.png",
                "paper3_kpi_result_path" : "../result/paper3/backtest_kpi.png",
                "paper4_kpi_result_path" : "../result/paper4/backtest_kpi.png",
                "paper6_kpi_result_path" : "../result/paper6/backtest_kpi.png",
                "paper7_kpi_result_path" : "../result/paper7/backtest_kpi.png",
                "paper9_kpi_result_path" : "../result/paper9/backtest_kpi.png",
                "paper11_kpi_result_path" : "../result/paper11/backtest_kpi.png",
                "consolidated_kpi_result_path" : "../result/consolidated/backtest_kpi.png",
                "sample_kpi_result_path" : "../result/sample/backtest_kpi.png"
                }
}

```

The outputs shoule all be placed in `result` folder.

Considering different combinations of `train_valid_period` and `test_period`, in the `result` folder there will be different folders with name rules `A_B`, a spreadsheet to record the corresponding metrics for these combinations, like:

| **train_valid_period** | **test_period** | **Calmar Ratio** | **annual return** | **max draw down** |
|------------------------|-----------------|-------------------|-------------------| ---|
| 11                      |      1           |       0.419961679            |          24.11         |-57.41 |
		

## TODO List
- To allow features with daily frequency to be fed into the ml model
- To include stocks in the Nasdaq and other widely used indices in our model
- Multidimensional heatmap
